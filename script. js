// تحديث الوقت والتاريخ
function updateTime() {
  const now = new Date();
  const daysAr = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
  const daysFr = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
  const monthsAr = ['جانفي', 'فيفري', 'مارس', 'أفريل', 'ماي', 'جوان', 'جويلية', 'أوت', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
  const monthsFr = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

  let lang = localStorage.getItem('lang') || 'ar';

  const dayName = lang === 'ar' ? daysAr[now.getDay()] : daysFr[now.getDay()];
  const monthName = lang === 'ar' ? monthsAr[now.getMonth()] : monthsFr[now.getMonth()];

  const date = now.getDate();
  const hours = now.getHours().toString().padStart(2, '0');
  const minutes = now.getMinutes().toString().padStart(2, '0');

  const timeString = lang === 'ar'
    ? `${dayName} ${date} ${monthName} - ${hours}:${minutes}`
    : `${dayName} ${date} ${monthName} - ${hours}h${minutes}`;

  const timeElem = document.getElementById('current-time');
  if (timeElem) {
    timeElem.textContent = timeString;
  }
}

// عداد الزيارات مع تخزين محلي
function updateVisits() {
  let visits = localStorage.getItem('visit-count');
  visits = visits ? parseInt(visits) + 1 : 1;
  localStorage.setItem('visit-count', visits);
  const visitElem = document.getElementById('visit-count');
  if (visitElem) {
    visitElem.textContent = (localStorage.getItem('lang') === 'fr') 
      ? `Nombre de visites: ${visits}` 
      : `عدد الزيارات: ${visits}`;
  }
}

// تحميل أخبار BBC عربي (أو فرنسي حسب اللغة)
function loadNews() {
  const rssUrl = 'http://feeds.bbci.co.uk/arabic/rss.xml';
  const newsElem = document.getElementById('live-news');
  fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`)
    .then(response => response.json())
    .then(data => {
      if (!data.items) throw new Error('No news items');
      let newsItems = data.items.slice(0, 4);
      let lang = localStorage.getItem('lang') || 'ar';

      if (lang === 'fr') {
        // بدل رابط RSS لفرنسية BBC لو تحب (مثلاً)
        // لكن هنا نخلي نفس الأخبار بالعربية عشان البساطة
        newsItems = data.items.slice(0, 4);
      }

      const newsText = newsItems.map(item => `📰 ${item.title}`).join(' ⚡ ');
      if (newsElem) newsElem.textContent = newsText;
    })
    .catch(err => {
      if (newsElem) newsElem.textContent = (localStorage.getItem('lang') === 'fr')
        ? '❌ Échec du chargement des actualités.'
        : '❌ فشل تحميل الأخبار.';
    });
}

// تغيير اللغة وتطبيق النصوص
function toggleLang() {
  let currentLang = localStorage.getItem('lang') || 'ar';
  let newLang = currentLang === 'ar' ? 'fr' : 'ar';
  localStorage.setItem('lang', newLang);
  applyLang();
}

function applyLang() {
  let lang = localStorage.getItem('lang') || 'ar';
  document.documentElement.lang = lang;
  document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

  // زر تغيير اللغة
  const langToggleBtn = document.querySelector('.lang-toggle');
  if (langToggleBtn) {
    langToggleBtn.textContent = lang === 'ar' ? 'Français' : 'العربية';
  }

  // تغيير نص العنوان العام مثلاً
  const titleElem = document.getElementById('title');
  if (titleElem) {
    titleElem.textContent = (lang === 'ar') ? titleElem.dataset.ar : titleElem.dataset.fr;
  }

  // كل العناصر التي تحتوي على نصوص متعددة اللغات
  document.querySelectorAll('.t').forEach(el => {
    if (el.dataset && el.dataset.ar && el.dataset.fr) {
      el.textContent = lang === 'ar' ? el.dataset.ar : el.dataset.fr;
    }
  });

  // تحديث الوقت والزيارات والأخبار بعد تغيير اللغة
  updateTime();
  updateVisits();
  loadNews();
}

// التحكم في عرض الصور (Lightbox)
function openLightbox(src) {
  const lightbox = document.getElementById('lightbox');
  const img = document.getElementById('lightbox-img');
  if (lightbox && img) {
    img.src = src;
    lightbox.style.display = 'flex';
  }
}

function closeLightbox() {
  const lightbox = document.getElementById('lightbox');
  if (lightbox) {
    lightbox.style.display = 'none';
  }
}

// تفعيل الأسئلة الشائعة (فتح وغلق)
function setupFAQ() {
  document.querySelectorAll('.faq-item h3').forEach(header => {
    header.addEventListener('click', () => {
      header.parentElement.classList.toggle('open');
    });
  });
}

// راديو القرآن (تشغيل/إيقاف)
let radioPlaying = false;
let radioAudio = null;

function toggleRadio() {
  if (!radioAudio) {
    radioAudio = new Audio('https://server7.mp3quran.net/maqri/002.mp3');
    radioAudio.loop = true;
  }
  if (radioPlaying) {
    radioAudio.pause();
    radioPlaying = false;
    document.getElementById('radio-btn').textContent = (localStorage.getItem('lang') === 'fr') ? '▶️ Radio' : '▶️ راديو القرآن';
  } else {
    radioAudio.play();
    radioPlaying = true;
    document.getElementById('radio-btn').textContent = (localStorage.getItem('lang') === 'fr') ? '⏸️ Pause' : '⏸️ إيقاف';
  }
}

// تهيئة كل الوظائف عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', () => {
  applyLang();
  setupFAQ();
  updateTime();
  updateVisits();
  loadNews();
  setInterval(updateTime, 60000);

  // ربط زر الراديو لو موجود
  const radioBtn = document.getElementById('radio-btn');
  if (radioBtn) {
    radioBtn.addEventListener('click', toggleRadio);
  }

  // ربط إغلاق الـ lightbox عند الضغط خارجه
  const lightbox = document.getElementById('lightbox');
  if (lightbox) {
    lightbox.addEventListener('click', closeLightbox);
  }
});
